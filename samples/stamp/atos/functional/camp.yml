#
# CAMP
#
# Copyright (C) 2017, 2018 SINTEF Digital
# All rights reserved.
#
# This software may be modified and distributed under the terms
# of the MIT license.  See the LICENSE file for details.
#

goals:
  running:
    - Entry

components:

  browser:
    provides_services: [ Entry ]
    requires_services: [ Test ]
    implementation:
      docker:
        file: browser/Dockerfile
    tests:
      command: pytest -v tests.py --junitxml=report.xml
      reports:
        location: "./"
        pattern: ".xml"
        format: junit

  hub:
    provides_services: [ Test ]
    requires_services: [ HttpProxy ]
    implementation:
      docker:
        image: selenium/hub

  apache:
    provides_services: [ HttpProxy ]
    requires_services: [ CityGo ]
    implementation:
      docker:
        file: apache/Dockerfile
    realization:
      - select: docker-compose-apache.yml
        instead_of:
          - docker-compose-nginx.yml
        as: docker-compose.yml

  nginx:
    provides_services: [ HttpProxy ]
    requires_services: [ CityGo ]
    variables:
      gzip:
        values: [on, off]
        realization:
          - targets: [ docker-compose.yml ]
            pattern: "gzip=on"
            replacements:
              - gzip=on
              - gzip=off
    implementation:
      docker:
        file: nginx/Dockerfile
    realization:
      - select: docker-compose-nginx.yml
        instead_of:
          - docker-compose-apache.yml
        as: docker-compose.yml
        
  citygo:
    provides_services: [ CityGo ]
    requires_services: [ Postgres, Mongo ]
    requires_features: [ Python ]
    variables:
      django:
        values: [ v1.10.2, v2.2.6 ]
        realization:
          - targets: [ citygo/requirements.txt ]
            pattern: "Django==1.10.2"
            replacements:
              - "Django==1.10.2"
              - "Django==2.2.6"
    implementation:
      docker:
        file: citygo/Dockerfile

  ubuntu:
    provides_features: [ Ubuntu ]
    implementation:
      docker:
        image: ubuntu:xenial
        
  mongo:
    provides_services: [ Mongo ]
    implementation:
      docker:
        image: mongo:4.0.6-xenial

  python:
    provides_features: [ Python ]
    requires_features: [ Ubuntu ]
    implementation:
      docker:
        file: python/Dockerfile

  postgres:
    provides_services: [ Postgres ]
    variables:
      version:
        values: [v9, v10, v11]
        realization:
          - targets: [ "postgres/Dockerfile" ]
            pattern: "FROM postgres:9.3"
            replacements:
              - "FROM postgres:9.3"
              - "FROM postgres:10"
              - "FROM postgres:11"
    implementation:
      docker:
        file: postgres/Dockerfile

